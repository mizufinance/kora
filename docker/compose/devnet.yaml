name: kora-devnet

networks:
  kora-net:
    driver: bridge

volumes:
  data_node0:
  data_node1:
  data_node2:
  data_node3:
  shared_config:
  prometheus_data:
  grafana_data:

x-node-common: &node-common
  image: kora:local
  networks:
    - kora-net
  environment:
    - RUST_LOG=${RUST_LOG:-info}
    - CHAIN_ID=${CHAIN_ID:-1337}

x-validator-common: &validator-common
  <<: *node-common
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "/scripts/healthcheck.sh"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 30s
  environment:
    - RUST_LOG=${RUST_LOG:-info}
    - CHAIN_ID=${CHAIN_ID:-1337}
    - HEALTHCHECK_MODE=ready

services:
  init-config:
    <<: *node-common
    user: root
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "[init] Running keygen setup..." && \
        /usr/local/bin/keygen setup \
          --validators=4 \
          --threshold=3 \
          --chain-id=${CHAIN_ID:-1337} \
          --output-dir=/shared && \
        echo "[init] Running trusted dealer DKG..." && \
        /usr/local/bin/keygen dkg-deal \
          --validators=4 \
          --threshold=3 \
          --output-dir=/shared && \
        echo "[init] Setting permissions..." && \
        chown -R 1000:1000 /shared/node0 /shared/node1 /shared/node2 /shared/node3 && \
        echo "[init] Init complete"
    volumes:
      - shared_config:/shared
      - data_node0:/shared/node0
      - data_node1:/shared/node1
      - data_node2:/shared/node2
      - data_node3:/shared/node3

  dkg-node0:
    <<: *node-common
    profiles: ["distributed-dkg"]
    hostname: node0
    depends_on:
      init-config:
        condition: service_completed_successfully
    entrypoint: ["/scripts/entrypoint.sh", "dkg"]
    volumes:
      - shared_config:/shared:ro
      - data_node0:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=0
      - IS_BOOTSTRAP=true
      - HEALTHCHECK_MODE=dkg
    ports:
      - "30300:30303"
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 5s
      timeout: 3s
      retries: 120
      start_period: 10s

  dkg-node1:
    <<: *node-common
    profiles: ["distributed-dkg"]
    hostname: node1
    depends_on:
      init-config:
        condition: service_completed_successfully
      dkg-node0:
        condition: service_started
    entrypoint: ["/scripts/entrypoint.sh", "dkg"]
    volumes:
      - shared_config:/shared:ro
      - data_node1:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=1
      - IS_BOOTSTRAP=false
      - BOOTSTRAP_PEERS=node0:30303
      - HEALTHCHECK_MODE=dkg
    ports:
      - "30301:30303"
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 5s
      timeout: 3s
      retries: 120
      start_period: 10s

  dkg-node2:
    <<: *node-common
    profiles: ["distributed-dkg"]
    hostname: node2
    depends_on:
      init-config:
        condition: service_completed_successfully
      dkg-node0:
        condition: service_started
    entrypoint: ["/scripts/entrypoint.sh", "dkg"]
    volumes:
      - shared_config:/shared:ro
      - data_node2:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=2
      - IS_BOOTSTRAP=false
      - BOOTSTRAP_PEERS=node0:30303
      - HEALTHCHECK_MODE=dkg
    ports:
      - "30302:30303"
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 5s
      timeout: 3s
      retries: 120
      start_period: 10s

  dkg-node3:
    <<: *node-common
    profiles: ["distributed-dkg"]
    hostname: node3
    depends_on:
      init-config:
        condition: service_completed_successfully
      dkg-node0:
        condition: service_started
    entrypoint: ["/scripts/entrypoint.sh", "dkg"]
    volumes:
      - shared_config:/shared:ro
      - data_node3:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=3
      - IS_BOOTSTRAP=false
      - BOOTSTRAP_PEERS=node0:30303
      - HEALTHCHECK_MODE=dkg
    ports:
      - "30303:30303"
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 5s
      timeout: 3s
      retries: 120
      start_period: 10s

  validator-node0:
    <<: *validator-common
    hostname: node0
    depends_on:
      init-config:
        condition: service_completed_successfully
    entrypoint: ["/scripts/entrypoint.sh", "validator"]
    volumes:
      - shared_config:/shared:ro
      - data_node0:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=0
      - IS_BOOTSTRAP=true
      - HEALTHCHECK_MODE=ready
    ports:
      - "30400:30303"
      - "8545:8545"
      - "9000:9002"

  validator-node1:
    <<: *validator-common
    hostname: node1
    depends_on:
      init-config:
        condition: service_completed_successfully
      validator-node0:
        condition: service_healthy
    entrypoint: ["/scripts/entrypoint.sh", "validator"]
    volumes:
      - shared_config:/shared:ro
      - data_node1:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=1
      - IS_BOOTSTRAP=false
      - BOOTSTRAP_PEERS=node0:30303
      - HEALTHCHECK_MODE=ready
    ports:
      - "30401:30303"
      - "8546:8546"
      - "9001:9002"

  validator-node2:
    <<: *validator-common
    hostname: node2
    depends_on:
      init-config:
        condition: service_completed_successfully
      validator-node0:
        condition: service_healthy
    entrypoint: ["/scripts/entrypoint.sh", "validator"]
    volumes:
      - shared_config:/shared:ro
      - data_node2:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=2
      - IS_BOOTSTRAP=false
      - BOOTSTRAP_PEERS=node0:30303
      - HEALTHCHECK_MODE=ready
    ports:
      - "30402:30303"
      - "8547:8547"
      - "9002:9002"

  validator-node3:
    <<: *validator-common
    hostname: node3
    depends_on:
      init-config:
        condition: service_completed_successfully
      validator-node0:
        condition: service_healthy
    entrypoint: ["/scripts/entrypoint.sh", "validator"]
    volumes:
      - shared_config:/shared:ro
      - data_node3:/data
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHAIN_ID=${CHAIN_ID:-1337}
      - VALIDATOR_INDEX=3
      - IS_BOOTSTRAP=false
      - BOOTSTRAP_PEERS=node0:30303
      - HEALTHCHECK_MODE=ready
    ports:
      - "30403:30303"
      - "8548:8548"
      - "9003:9002"

  prometheus:
    image: prom/prometheus:latest
    profiles: ["observability"]
    volumes:
      - prometheus_data:/prometheus
      - ../config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    networks:
      - kora-net

  grafana:
    image: grafana/grafana:latest
    profiles: ["observability"]
    depends_on:
      - prometheus
    volumes:
      - grafana_data:/var/lib/grafana
      - ../grafana/provisioning:/etc/grafana/provisioning:ro
      - ../grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    ports:
      - "3000:3000"
    networks:
      - kora-net
